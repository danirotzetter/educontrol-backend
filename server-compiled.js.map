{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["/**\r\n * Require libraries\r\n */\r\nconst express = require('express');\r\nconst bodyParser = require('body-parser');\r\nconst mongoose = require('mongoose'); // To simplify dealing with mongodb\r\nconst http = require('http'); // For base http operations\r\nconst config = require('./app/config.js'); // Loads the configuration\r\nconst app = express();\r\nconst router = express.Router(); // get an instance of the express Router\r\nvar morgan = require('morgan'); // Logging\r\nvar jwt = require('jsonwebtoken'); // used to create, sign, and verify tokens\r\nvar cors = require('cors'); // Allow cross-site requests\r\n\r\n\r\nconsole.log('Starting server in environment \"' + config.get('env') + '\"');\r\n\r\n/**\r\n * Configure the application\r\n */\r\napp.use(bodyParser.urlencoded({extended: true})); // Simplified body reading: adds <form> element data to the body\r\napp.use(bodyParser.json());\r\nif (config.get('dev')) {\r\n    app.use(morgan('dev'));// use morgan to log requests to the console\r\n}\r\napp.set('jsonTokenVerificationSecret', config.get('security:jsonTokenVerificationSecret')); // secret variable to verify JSON tokens\r\napp.use(cors()); // Allow cross-site requests\r\n/**\r\n * Load controllers\r\n */\r\nvar userCtrl = require('./controllers/user-ctrl.js');\r\nvar metricCtrl = require('./controllers/metric-ctrl.js');\r\nvar projectCtrl = require('./controllers/project-ctrl.js');\r\nvar schoolsCtrl = require('./controllers/school-ctrl.js');\r\nvar regionsCtrl = require('./controllers/region-ctrl.js');\r\nvar districtsCtrl = require('./controllers/district-ctrl.js');\r\n\r\n/**\r\n * ==================\r\n * START ROUTES\r\n * ==================\r\n */\r\n/**\r\n * Add routing middleware to require authentication and authorization\r\n */\r\nrouter.use(function (req, res, next) {\r\n\r\n    // Define routes that are accessible without authentication\r\n    var unauthAccess = [\r\n        '/users/login'\r\n    ];\r\n\r\n    console.log('Skip authentication? '+config.get('security:noAuthentication'));\r\n\r\n    /**\r\n     * Skip routes that require no authentication\r\n     * Skip authentication if defined so in the properties\r\n     */\r\n    if (unauthAccess.indexOf(req.url) >= 0 || config.get('security:noAuthentication')) {\r\n        // Allowed in any case, without authentication/ authorization\r\n        next();\r\n    }\r\n    else {\r\n        // Route that requires authentication\r\n\r\n        // check header or url parameters or post parameters for token\r\n        var token = req.body.token || req.query.token || req.headers['x-access-token'];\r\n\r\n        // decode token\r\n        if (token) {\r\n\r\n            // verifies secret and checks exp\r\n            jwt.verify(token, app.get('jsonTokenVerificationSecret'), function (err, decoded) {\r\n                if (err) {\r\n                    return res.json({success: false, message: 'Failed to authenticate token.'});\r\n                } else {\r\n                    // if everything is good, save to request for use in other routes\r\n                    req.decoded = decoded;\r\n                    next();\r\n                }\r\n            });\r\n\r\n        } else {\r\n            // if there is no token\r\n            // return an error\r\n            return res.status(403).send({\r\n                success: false,\r\n                message: 'No token provided.'\r\n            });\r\n\r\n        }\r\n    }\r\n});\r\n\r\nrouter.get('/', function (req, res) {\r\n    res.json({message: 'Please use an api call'});\r\n});\r\n// REGISTER ROUTES -------------------------------\r\napp.use('/', router);\r\napp.use('/users', userCtrl);\r\napp.use('/metrics', metricCtrl);\r\napp.use('/projects', projectCtrl);\r\napp.use('/schools', schoolsCtrl);\r\napp.use('/regions', regionsCtrl);\r\napp.use('/districts', districtsCtrl);\r\n\r\n/**\r\n * ==================\r\n * END ROUTES\r\n * ==================\r\n */\r\n\r\n\r\n/**\r\n * Launch the application if connection to MongoDB is successful\r\n */\r\nvar mongoDbUrl = 'mongodb://' + config.get('db:username') + ':' + config.get('db:password') + '@' + config.get('db:host') + ':' + config.get('db:port') + '/' + config.get('db:database');\r\nconsole.log('Attempt to connect to ' + mongoDbUrl);\r\nmongoose.Promise = global.Promise; // Use updated promise (without this setup, a deprecated warning from mongoose will show up)\r\nmongoose.connect(mongoDbUrl, (err, database) => {\r\n    // ... start the server\r\n    if (err) {\r\n        console.log('Cannot connect to database: ' + err);\r\n    }\r\n    else {\r\n        console.log('Successfully connected to database');\r\n    }\r\n\r\n    // Start listening\r\n    app.listen(config.get('app:port'), ()=> {\r\n        console.log('listening on port ' + config.get('app:port'))\r\n    });\r\n})\r\n;\r\n\r\n\r\n\r\n"]}